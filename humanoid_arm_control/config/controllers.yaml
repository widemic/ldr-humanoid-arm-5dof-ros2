controller_manager:
  ros__parameters:
    update_rate: 100  # Hz

    # Joint State Broadcaster
    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster

    # Joint Trajectory Controller (Main controller for coordinated motion)
    joint_trajectory_controller:
      type: joint_trajectory_controller/JointTrajectoryController

    # Individual Joint Controllers (for isolated PID tuning - using JointTrajectoryController with single joint)
    base_rotation_joint_position_controller:
      type: joint_trajectory_controller/JointTrajectoryController

    shoulder_pitch_joint_position_controller:
      type: joint_trajectory_controller/JointTrajectoryController

    elbow_pitch_joint_position_controller:
      type: joint_trajectory_controller/JointTrajectoryController

    wrist_pitch_joint_position_controller:
      type: joint_trajectory_controller/JointTrajectoryController

    wrist_roll_joint_position_controller:
      type: joint_trajectory_controller/JointTrajectoryController

    # Group Position Controller (all joints together)
    arm_position_controller:
      type: position_controllers/JointGroupPositionController

    # Group Velocity Controller
    arm_velocity_controller:
      type: velocity_controllers/JointGroupVelocityController

    # Force Torque Sensor Broadcaster (for contact sensing)
    tcp_force_torque_broadcaster:
      type: force_torque_sensor_broadcaster/ForceTorqueSensorBroadcaster

    forearm_force_torque_broadcaster:
      type: force_torque_sensor_broadcaster/ForceTorqueSensorBroadcaster

    wrist_force_torque_broadcaster:
      type: force_torque_sensor_broadcaster/ForceTorqueSensorBroadcaster

    # IMU Sensor Broadcaster
    arm_imu_broadcaster:
      type: imu_sensor_broadcaster/IMUSensorBroadcaster

# Joint Trajectory Controller Configuration
joint_trajectory_controller:
  ros__parameters:
    joints:
      - base_rotation_joint
      - shoulder_pitch_joint
      - elbow_pitch_joint
      - wrist_pitch_joint
      - wrist_roll_joint

    command_interfaces:
      - effort

    state_interfaces:
      - position
      - velocity

    state_publish_rate: 50.0
    action_monitor_rate: 20.0
    allow_partial_joints_goal: false

    # ros2_control PID gains - Controls torque output directly
    # BASELINE VALUES (2025-10-09) - Conservative starting point for tuning
    # Torque output is automatically clamped to motor limits from actuator_specs.yaml
    #
    # TUNING METHODOLOGY:
    # 1. Start with P only (D=0, I=0)
    # 2. Increase P until you see oscillations or overshoot
    # 3. Add D to dampen (start with D = P/10 to P/20)
    # 4. Add small I only if steady-state error persists (I = P/50 to P/100)
    # 5. Adjust i_clamp to prevent integral windup
    # 6. Tune feedforward for smoother tracking (start at 0.0, increase slowly)
    #
    # Expected behavior with effort control:
    # - You WILL see oscillations with high P
    # - You WILL see overshoot (not perfect tracking like position interface)
    # - Torque saturation is normal and expected
    gains:
      base_rotation_joint:
        # ROBSTRIDE 04: 120 Nm max, 20.94 rad/s max
        p: 200.0           # Start conservative (10-20% of previous aggressive value)
        d: 15.0            # D ≈ P/13 (good damping ratio)
        i: 2.0             # Small I to handle steady-state error
        i_clamp: 30.0      # Limit integral windup (~25% of max torque)
        ff_velocity_scale: 0.0  # Start at 0, increase if tracking lags velocity

      shoulder_pitch_joint:
        # ROBSTRIDE 04: 120 Nm max, 20.94 rad/s max
        # Higher gains due to gravity loading
        p: 250.0           # Slightly higher for gravity compensation
        d: 18.0            # D ≈ P/14
        i: 3.0             # Slightly higher I for gravity sag
        i_clamp: 35.0      # ~29% of max torque
        ff_velocity_scale: 0.0

      elbow_pitch_joint:
        # ROBSTRIDE 03: 60 Nm max, 20.42 rad/s max
        p: 150.0           # Lower due to smaller motor
        d: 12.0            # D ≈ P/12.5
        i: 2.0
        i_clamp: 20.0      # ~33% of max torque
        ff_velocity_scale: 0.0

      wrist_pitch_joint:
        # ROBSTRIDE 03: 60 Nm max, 20.42 rad/s max
        p: 120.0           # Lighter distal joint
        d: 10.0            # D ≈ P/12
        i: 1.5
        i_clamp: 18.0      # ~30% of max torque
        ff_velocity_scale: 0.0

      wrist_roll_joint:
        # ROBSTRIDE 02: 17 Nm max, 42.94 rad/s max (fastest joint)
        p: 80.0            # Smallest motor, lightest load
        d: 7.0             # D ≈ P/11.4
        i: 1.0
        i_clamp: 8.0       # ~47% of max torque (higher % due to small motor)
        ff_velocity_scale: 0.0

    # Trajectory constraints - relaxed for effort control (not perfect tracking)
    constraints:
      stopped_velocity_tolerance: 2.0  # rad/s - relaxed for effort control
      goal_time: 5.0  # seconds - generous time allowance for baseline PID

      base_rotation_joint:
        trajectory: 1.0   # rad - relaxed from 0.5 for conservative baseline
        goal: 0.15        # rad - tighter goal tolerance

      shoulder_pitch_joint:
        trajectory: 1.0   # rad - relaxed for gravity effects
        goal: 0.15        # rad

      elbow_pitch_joint:
        trajectory: 1.0   # rad
        goal: 0.15        # rad

      wrist_pitch_joint:
        trajectory: 1.0   # rad
        goal: 0.15        # rad

      wrist_roll_joint:
        trajectory: 1.5   # rad - highest tolerance for fastest joint
        goal: 0.20        # rad

# Individual Joint Controllers (JointTrajectoryController with single joint for isolated PID tuning)
# USE THESE for single-joint PID tuning - same baseline values as main controller
base_rotation_joint_position_controller:
  ros__parameters:
    joints:
      - base_rotation_joint
    command_interfaces:
      - effort
    state_interfaces:
      - position
      - velocity
    state_publish_rate: 50.0
    action_monitor_rate: 20.0
    allow_partial_joints_goal: false
    gains:
      base_rotation_joint:
        p: 200.0
        d: 15.0
        i: 2.0
        i_clamp: 30.0
        ff_velocity_scale: 0.0

shoulder_pitch_joint_position_controller:
  ros__parameters:
    joints:
      - shoulder_pitch_joint
    command_interfaces:
      - effort
    state_interfaces:
      - position
      - velocity
    state_publish_rate: 50.0
    action_monitor_rate: 20.0
    allow_partial_joints_goal: false
    gains:
      shoulder_pitch_joint:
        p: 250.0
        d: 18.0
        i: 3.0
        i_clamp: 35.0
        ff_velocity_scale: 0.0

elbow_pitch_joint_position_controller:
  ros__parameters:
    joints:
      - elbow_pitch_joint
    command_interfaces:
      - effort
    state_interfaces:
      - position
      - velocity
    state_publish_rate: 50.0
    action_monitor_rate: 20.0
    allow_partial_joints_goal: false
    gains:
      elbow_pitch_joint:
        p: 150.0
        d: 12.0
        i: 2.0
        i_clamp: 20.0
        ff_velocity_scale: 0.0

wrist_pitch_joint_position_controller:
  ros__parameters:
    joints:
      - wrist_pitch_joint
    command_interfaces:
      - effort
    state_interfaces:
      - position
      - velocity
    state_publish_rate: 50.0
    action_monitor_rate: 20.0
    allow_partial_joints_goal: false
    gains:
      wrist_pitch_joint:
        p: 120.0
        d: 10.0
        i: 1.5
        i_clamp: 18.0
        ff_velocity_scale: 0.0

wrist_roll_joint_position_controller:
  ros__parameters:
    joints:
      - wrist_roll_joint
    command_interfaces:
      - effort
    state_interfaces:
      - position
      - velocity
    state_publish_rate: 50.0
    action_monitor_rate: 20.0
    allow_partial_joints_goal: false
    gains:
      wrist_roll_joint:
        p: 80.0
        d: 7.0
        i: 1.0
        i_clamp: 8.0
        ff_velocity_scale: 0.0

# Group Position Controller
arm_position_controller:
  ros__parameters:
    joints:
      - base_rotation_joint
      - shoulder_pitch_joint
      - elbow_pitch_joint
      - wrist_pitch_joint
      - wrist_roll_joint
    command_interfaces:
      - position
    state_interfaces:
      - position
      - velocity

# Group Velocity Controller
arm_velocity_controller:
  ros__parameters:
    joints:
      - base_rotation_joint
      - shoulder_pitch_joint
      - elbow_pitch_joint
      - wrist_pitch_joint
      - wrist_roll_joint
    command_interfaces:
      - velocity
    state_interfaces:
      - position
      - velocity

# Force Torque Sensor Broadcasters
tcp_force_torque_broadcaster:
  ros__parameters:
    sensor_name: tcp_force_sensor
    state_interface_names:
      - force.x
      - force.y
      - force.z
      - torque.x
      - torque.y
      - torque.z
    frame_id: tcp_link
    topic_name: tcp_wrench

forearm_force_torque_broadcaster:
  ros__parameters:
    sensor_name: forearm_force_sensor
    state_interface_names:
      - force.x
      - force.y
      - force.z
      - torque.x
      - torque.y
      - torque.z
    frame_id: forearm_contact_link
    topic_name: forearm_wrench

wrist_force_torque_broadcaster:
  ros__parameters:
    sensor_name: wrist_force_sensor
    state_interface_names:
      - force.x
      - force.y
      - force.z
      - torque.x
      - torque.y
      - torque.z
    frame_id: wrist_contact_link
    topic_name: wrist_wrench

# IMU Sensor Broadcaster
arm_imu_broadcaster:
  ros__parameters:
    sensor_name: arm_imu
    state_interface_names:
      - orientation.x
      - orientation.y
      - orientation.z
      - orientation.w
      - angular_velocity.x
      - angular_velocity.y
      - angular_velocity.z
      - linear_acceleration.x
      - linear_acceleration.y
      - linear_acceleration.z
    frame_id: upper_arm_link
    topic_name: arm_imu/data