<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Materials -->
  <material name="base_material">
    <color rgba="0.8 0.8 1.0 1"/>
  </material>

  <material name="arm_material">
    <color rgba="0.79 0.82 0.93 1"/>
  </material>

  <material name="end_effector_material">
    <color rgba="0.82 0.82 1.0 1"/>
  </material>

  <!-- Robot macro -->
  <xacro:macro name="humanoid_arm_5dof_macro" params="prefix use_fake_hardware:=true fake_sensor_commands:=false slowdown:=3.0 robot_controller:=joint_trajectory_controller">

    <!-- Base Link -->
    <link name="${prefix}base_link">
      <inertial>
        <origin xyz="-0.025 0 0.262" rpy="0 0 0"/>
        <mass value="400"/>
        <inertia ixx="1.52" ixy="0" ixz="0.20" iyy="1.58" iyz="0" izz="0.18"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/suport.STL"/>
        </geometry>
        <material name="base_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/suport.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Shoulder Motor Link -->
    <link name="${prefix}shoulder_motor_link">
      <inertial>
        <origin xyz="0.024 0 0" rpy="0 0 0"/>
        <mass value="0.53"/>
        <inertia ixx="0.0009" ixy="0" ixz="0" iyy="0.0006" iyz="0" izz="0.0006"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor1.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor1.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Shoulder Motor Mount Joint (Fixed) -->
    <joint name="${prefix}shoulder_motor_mount_joint" type="fixed">
      <origin xyz="-0.383 0 1.099" rpy="0.018 0 0"/>
      <parent link="${prefix}base_link"/>
      <child link="${prefix}shoulder_motor_link"/>
    </joint>

    <!-- Upper Arm Link -->
    <link name="${prefix}upper_arm_link">
      <inertial>
        <origin xyz="-0.051 -0.040 0" rpy="0 0 0"/>
        <mass value="1.20"/>
        <inertia ixx="0.0035" ixy="-0.0017" ixz="0" iyy="0.0061" iyz="0" izz="0.0062"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/umar1.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/umar1.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Base Rotation Joint (1st DOF) -->
    <joint name="${prefix}base_rotation_joint" type="revolute">
      <origin xyz="-0.0175 0 0" rpy="0 0 0"/>
      <parent link="${prefix}shoulder_motor_link"/>
      <child link="${prefix}upper_arm_link"/>
      <axis xyz="1 0 0"/>
      <!-- Temporarily increased for PID tuning - Real motor: 120 Nm -->
      <limit lower="-3.14" upper="3.14" effort="500" velocity="3"/>
      <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- Shoulder Pitch Motor Link -->
    <link name="${prefix}shoulder_pitch_motor_link">
      <inertial>
        <origin xyz="0 0.024 0" rpy="0 0 0"/>
        <mass value="0.53"/>
        <inertia ixx="0.0006" ixy="0" ixz="0" iyy="0.0009" iyz="0" izz="0.0006"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor2.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor2.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Shoulder Pitch Joint (2nd DOF) -->
    <joint name="${prefix}shoulder_pitch_joint" type="revolute">
      <origin xyz="-0.099 -0.053 0" rpy="0 0 0"/>
      <parent link="${prefix}upper_arm_link"/>
      <child link="${prefix}shoulder_pitch_motor_link"/>
      <axis xyz="0 1 0"/>
      <limit lower="-0.55" upper="3.1" effort="120" velocity="3"/>
      <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- Forearm Link -->
    <link name="${prefix}forearm_link">
      <inertial>
        <origin xyz="0 0.014 0.024" rpy="0 0 0"/>
        <mass value="0.97"/>
        <inertia ixx="0.0051" ixy="0" ixz="0" iyy="0.0056" iyz="-0.0006" izz="0.0017"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/umar2.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/umar2.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Forearm Mount Joint (Fixed) -->
    <joint name="${prefix}forearm_mount_joint" type="fixed">
      <origin xyz="-0.016 0.040 -0.076" rpy="0 0.211 0"/>
      <parent link="${prefix}shoulder_pitch_motor_link"/>
      <child link="${prefix}forearm_link"/>
    </joint>

    <!-- Elbow Motor Link -->
    <link name="${prefix}elbow_motor_link">
      <inertial>
        <origin xyz="0 0 0.027" rpy="0 0 0"/>
        <mass value="0.36"/>
        <inertia ixx="0.0003" ixy="0" ixz="0" iyy="0.0003" iyz="0" izz="0.0004"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor3.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor3.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Elbow Motor Mount Joint (Fixed) -->
    <joint name="${prefix}elbow_motor_mount_joint" type="fixed">
      <origin xyz="0 0.002 -0.100" rpy="-0.018 0 0.040"/>
      <parent link="${prefix}forearm_link"/>
      <child link="${prefix}elbow_motor_link"/>
    </joint>

    <!-- Elbow Flange Link -->
    <link name="${prefix}elbow_flange_link">
      <inertial>
        <origin xyz="0.001 0 0.005" rpy="0 0 0"/>
        <mass value="0.036"/>
        <inertia ixx="0.00001" ixy="0" ixz="0" iyy="0.00001" iyz="0" izz="0.00002"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/flansa .STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/flansa .STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Elbow Pitch Joint (3rd DOF) -->
    <joint name="${prefix}elbow_pitch_joint" type="revolute">
      <origin xyz="0 0.0002 -0.012" rpy="0.018 -0.210 -0.044"/>
      <parent link="${prefix}elbow_motor_link"/>
      <child link="${prefix}elbow_flange_link"/>
      <axis xyz="-0.209 0 -0.978"/>
      <limit lower="-3.14" upper="3.14" effort="60" velocity="1.6"/>
      <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- Wrist Base Link -->
    <link name="${prefix}wrist_base_link">
      <inertial>
        <origin xyz="0.028 0.0005 -0.026" rpy="0 0 0"/>
        <mass value="0.49"/>
        <inertia ixx="0.0015" ixy="0" ixz="0.0003" iyy="0.0013" iyz="0" izz="0.0008"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/cot1.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/cot1.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Wrist Base Mount Joint (Fixed) -->
    <joint name="${prefix}wrist_base_mount_joint" type="fixed">
      <origin xyz="-0.008 0 -0.036" rpy="-0.009 0.210 0.041"/>
      <parent link="${prefix}elbow_flange_link"/>
      <child link="${prefix}wrist_base_link"/>
    </joint>

    <!-- Wrist Motor Link -->
    <link name="${prefix}wrist_motor_link">
      <inertial>
        <origin xyz="0.027 0 0" rpy="0 0 0"/>
        <mass value="0.36"/>
        <inertia ixx="0.0004" ixy="0" ixz="0" iyy="0.0003" iyz="0" izz="0.0003"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor4.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor4.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Wrist Motor Mount Joint (Fixed) -->
    <joint name="${prefix}wrist_motor_mount_joint" type="fixed">
      <origin xyz="-0.003 0.001 -0.048" rpy="0.018 0 0"/>
      <parent link="${prefix}wrist_base_link"/>
      <child link="${prefix}wrist_motor_link"/>
    </joint>

    <!-- Wrist Pitch Link -->
    <link name="${prefix}wrist_pitch_link">
      <inertial>
        <origin xyz="-0.017 0.032 0.0003" rpy="0 0 0"/>
        <mass value="0.71"/>
        <inertia ixx="0.0027" ixy="-0.0004" ixz="0" iyy="0.0007" iyz="0" izz="0.0025"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/cot2.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/cot2.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Wrist Pitch Joint (4th DOF) -->
    <joint name="${prefix}wrist_pitch_joint" type="revolute">
      <origin xyz="0 0 0" rpy="-0.271 0 0"/>
      <parent link="${prefix}wrist_motor_link"/>
      <child link="${prefix}wrist_pitch_link"/>
      <axis xyz="-1 0 0"/>
      <limit lower="-0.31" upper="2.8" effort="60" velocity="1.6"/>
      <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- Wrist Assembly Link -->
    <link name="${prefix}wrist_assembly_link">
      <inertial>
        <origin xyz="0 0.048 0.009" rpy="0 0 0"/>
        <mass value="0.25"/>
        <inertia ixx="0.0004" ixy="0" ixz="0" iyy="0.00015" iyz="0" izz="0.0004"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/cot3.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/cot3.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Wrist Assembly Joint (Fixed) -->
    <joint name="${prefix}wrist_assembly_joint" type="fixed">
      <origin xyz="0 0.179 -0.010" rpy="0 0 0"/>
      <parent link="${prefix}wrist_pitch_link"/>
      <child link="${prefix}wrist_assembly_link"/>
    </joint>

    <!-- Wrist Roll Motor Link -->
    <link name="${prefix}wrist_roll_motor_link">
      <inertial>
        <origin xyz="0 -0.023 0" rpy="0 0 0"/>
        <mass value="0.18"/>
        <inertia ixx="0.00009" ixy="0" ixz="0" iyy="0.00013" iyz="0" izz="0.00009"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor5.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor5.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Wrist Roll Motor Mount Joint (Fixed) -->
    <joint name="${prefix}wrist_roll_motor_mount_joint" type="fixed">
      <origin xyz="0 0.126 0.010" rpy="0 0 0"/>
      <parent link="${prefix}wrist_assembly_link"/>
      <child link="${prefix}wrist_roll_motor_link"/>
    </joint>

    <!-- End Effector Link -->
    <link name="${prefix}end_effector_link">
      <inertial>
        <origin xyz="0.018 0.024 0.0001" rpy="0 0 0"/>
        <mass value="0.27"/>
        <inertia ixx="0.0006" ixy="-0.00015" ixz="0" iyy="0.0003" iyz="0" izz="0.0006"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/incheietura.STL"/>
        </geometry>
        <material name="end_effector_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/incheietura.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- Wrist Roll Joint (5th DOF) -->
    <joint name="${prefix}wrist_roll_joint" type="revolute">
      <origin xyz="0 0.026 0" rpy="0 -0.013 0"/>
      <parent link="${prefix}wrist_roll_motor_link"/>
      <child link="${prefix}end_effector_link"/>
      <axis xyz="0 -1 0"/>
      <limit lower="-3.14" upper="3.14" effort="17" velocity="0.8"/>
      <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- End Motor Link (Optional - for completeness) -->
    <link name="${prefix}end_motor_link">
      <inertial>
        <origin xyz="0.023 0 0" rpy="0 0 0"/>
        <mass value="0.18"/>
        <inertia ixx="0.00013" ixy="0" ixz="0" iyy="0.00009" iyz="0" izz="0.00009"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor6.STL"/>
        </geometry>
        <material name="arm_material"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://humanoid_arm_description/meshes/pmotor6.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- End Motor Mount Joint (Fixed) -->
    <joint name="${prefix}end_motor_mount_joint" type="fixed">
      <origin xyz="0 0.065 0" rpy="0.252 0 0"/>
      <parent link="${prefix}end_effector_link"/>
      <child link="${prefix}end_motor_link"/>
    </joint>

    <!-- Tool Center Point (TCP) Frame -->
    <link name="${prefix}tcp_link"/>
    <joint name="${prefix}tcp_joint" type="fixed">
      <origin xyz="0.05 0.1 0" rpy="0 0 0"/>
      <parent link="${prefix}end_effector_link"/>
      <child link="${prefix}tcp_link"/>
    </joint>

    <!-- Contact Sensor Points for Whole-Arm Manipulation -->
    <link name="${prefix}forearm_contact_link"/>
    <joint name="${prefix}forearm_contact_joint" type="fixed">
      <origin xyz="0 0.05 -0.05" rpy="0 0 0"/>
      <parent link="${prefix}forearm_link"/>
      <child link="${prefix}forearm_contact_link"/>
    </joint>

    <link name="${prefix}wrist_contact_link"/>
    <joint name="${prefix}wrist_contact_joint" type="fixed">
      <origin xyz="0 0.1 0" rpy="0 0 0"/>
      <parent link="${prefix}wrist_pitch_link"/>
      <child link="${prefix}wrist_contact_link"/>
    </joint>

    <!-- ros2_control Integration -->
    <xacro:humanoid_arm_5dof_ros2_control
      name="HumanoidArm5DOF"
      prefix="${prefix}"
      use_fake_hardware="${use_fake_hardware}"
      fake_sensor_commands="${fake_sensor_commands}"
      slowdown="${slowdown}"
      robot_controller="${robot_controller}" />

  </xacro:macro>

</robot>